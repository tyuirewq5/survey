<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Response</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small polish */
    .glass {
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(6px);
    }
    .card-shadow {
      box-shadow: 0 8px 30px rgba(2,6,23,0.12);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-sky-50 min-h-screen text-slate-800">

  <!-- NAV -->
  <header class="max-w-6xl mx-auto p-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <button onclick="goBack()" class="p-2 rounded-md bg-white/90 hover:bg-white card-shadow">
        <!-- back icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <h1 class="text-2xl font-semibold">Response Viewer</h1>
    </div>

    <div class="flex items-center gap-3">
      <button id="downloadJsonBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Download JSON</button>
      <button id="exportCsvBtn" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Export CSV</button>
      <button id="printBtn" class="px-3 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Print</button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-6">
    <!-- Summary -->
    <section id="summary" class="glass card-shadow rounded-xl p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-sm text-slate-500">Response ID</div>
          <div id="summaryResponseId" class="text-lg font-bold text-slate-700"></div>
        </div>

        <div>
          <div class="text-sm text-slate-500">Name</div>
          <div id="summaryName" class="text-lg font-semibold text-slate-800">—</div>
        </div>

        <div>
          <div class="text-sm text-slate-500">Filled On</div>
          <div id="summaryFilledOn" class="text-lg font-medium text-slate-700">—</div>
        </div>

        <div>
          <div class="text-sm text-slate-500">Questions Answered</div>
          <div id="summaryCount" class="text-lg font-medium text-slate-700">0</div>
        </div>
      </div>
    </section>

    <!-- Answers timeline -->
    <section id="answersSection" class="space-y-4">
      <!-- dynamic content will be inserted here -->
      <div id="loader" class="flex items-center justify-center p-10">
        <svg class="animate-spin h-8 w-8 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
        </svg>
      </div>
    </section>

    <!-- Footer actions -->
    <section class="mt-8 flex justify-end gap-3">
      <button onclick="goBack()" class="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300">Back to Dashboard</button>
    </section>
  </main>

<script>
  const API_URL = "https://broad-sunset-7ec2.byash278.workers.dev";

  // protect route - same check as other pages
  if (!localStorage.getItem("loggedIn")) {
    // small delay so page doesn't flicker
    setTimeout(() => window.location.href = "index.html", 200);
  }

  // parse responseid from query string
  const params = new URLSearchParams(location.search);
  const RESPONSE_ID = params.get("responseid");

  if (!RESPONSE_ID) {
    document.getElementById("answersSection").innerHTML = `
      <div class="p-6 bg-white rounded shadow text-center">
        <div class="text-lg font-semibold">No response selected</div>
        <div class="text-sm text-slate-500 mt-2">Please open this page with ?responseid=...</div>
      </div>`;
    throw new Error("Missing responseid");
  }

  // UI elements
  const elResponseId = document.getElementById("summaryResponseId");
  const elName = document.getElementById("summaryName");
  const elFilledOn = document.getElementById("summaryFilledOn");
  const elCount = document.getElementById("summaryCount");
  const answersSection = document.getElementById("answersSection");
  const loader = document.getElementById("loader");

  elResponseId.innerText = RESPONSE_ID;

  // fetch function tries targeted endpoint first, else falls back to all results
  async function fetchResponseRows(responseid) {
    // try /responses?responseid=...
    try {
      const q = `${API_URL}/responses?responseid=${encodeURIComponent(responseid)}`;
      const r = await fetch(q);
      if (r.ok) {
        const json = await r.json();
        // expecting either array of rows or an object with results
        if (Array.isArray(json)) return json;
        if (json && Array.isArray(json.results)) return json.results;
      }
    } catch (e) {
      console.warn("Query endpoint failed, falling back to full fetch:", e);
    }

    // fallback: get all and filter client-side
    const allRes = await fetch(API_URL + "/responses");
    if (!allRes.ok) throw new Error("Failed to fetch responses");
    const allJson = await allRes.json();
    // support env.DB.prepare(...).all() style (returns { results: [...] }) or plain array
    const rows = Array.isArray(allJson) ? allJson : (allJson.results || []);
    return rows.filter(r => String(r.responseid) === String(responseid));
  }

  // render the response nicely
  function renderRows(rows) {
    loader?.remove();

    if (!rows || rows.length === 0) {
      answersSection.innerHTML = `
        <div class="p-6 bg-white rounded shadow text-center">
          <div class="text-lg font-semibold">No answers found for this Response ID</div>
          <div class="text-sm text-slate-500 mt-2">Maybe the ID is incorrect or the submission didn't complete.</div>
        </div>`;
      return;
    }

    // find name (questionid == 1)
    const nameRow = rows.find(r => Number(r.questionid) === 1);
    const name = nameRow ? nameRow.answer : "—";
    elName.innerText = name;

    // filled_on → earliest created_at (or latest depending on your preference)
    const times = rows.map(r => r.created_at).filter(Boolean);
    const filledOn = times.length ? new Date(times.sort()[0]).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : "—";
    elFilledOn.innerText = filledOn;
    elCount.innerText = rows.length;

    // We will display a sorted list by questionid (or created_at fallback)
    rows.sort((a,b) => {
      // try numeric questionid
      const qa = Number(a.questionid) || 0;
      const qb = Number(b.questionid) || 0;
      if (qa && qb) return qa - qb;
      // fallback to created_at
      return new Date(a.created_at) - new Date(b.created_at);
    });

    // Build HTML: timeline style
    const timelineHtml = [];
    rows.forEach((r, i) => {
      const qid = r.questionid;
      const answer = r.answer ?? "—";
      const time = r.created_at ? new Date(r.created_at).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : "";
      timelineHtml.push(`
        <article class="bg-white rounded-xl p-6 card-shadow">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center bg-sky-50 text-sky-600 font-semibold">
              Q${qid}
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-slate-800">Question ID: ${qid}</h3>
                <div class="text-sm text-slate-500">${time}</div>
              </div>
              <p class="mt-3 text-slate-700">${escapeHtml(answer)}</p>
            </div>
          </div>
        </article>
      `);
    });

    answersSection.innerHTML = timelineHtml.join("\n");
  }

  // small helper to escape HTML in answer text
  function escapeHtml(text) {
    if (text === null || text === undefined) return "—";
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Export JSON
  function downloadJSON(rows) {
    const data = { responseid: RESPONSE_ID, rows, exported_at: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `response_${RESPONSE_ID}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Export CSV (questionid, answer, created_at)
  function exportCSV(rows) {
    const header = ["questionid", "answer", "created_at"];
    const lines = [header.join(",")];
    rows.forEach(r => {
      const line = [
        `"${String(r.questionid).replace(/"/g,'""')}"`,
        `"${String(r.answer ?? "").replace(/"/g,'""')}"`,
        `"${String(r.created_at ?? "").replace(/"/g,'""')}"`
      ];
      lines.push(line.join(","));
    });
    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `response_${RESPONSE_ID}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Print (prints the main section)
  function doPrint() {
    const printWindow = window.open("", "_blank");
    const style = `
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; color: #111827; }
        .card { border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.08); background:white; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
      </style>`;
    const rowsHtml = window._currentRows ? window._currentRows.map(r => `
      <div class="card">
        <div style="display:flex;justify-content:space-between;">
          <strong>Q${escapeHtml(r.questionid)}</strong>
          <small>${escapeHtml(r.created_at || "")}</small>
        </div>
        <div style="margin-top:8px">${escapeHtml(r.answer || "—")}</div>
      </div>
    `).join("") : "<div>No data</div>";
    printWindow.document.write(`<html><head><title>Response ${RESPONSE_ID}</title>${style}</head><body>
      <div class="header"><h2>Response ${RESPONSE_ID}</h2><div>${escapeHtml(elName.innerText)}</div></div>
      ${rowsHtml}
    </body></html>`);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  }

  // go back
  function goBack() {
    window.location.href = "dashboard.html";
  }

  // wire up buttons
  document.getElementById("downloadJsonBtn").addEventListener("click", () => {
    if (window._currentRows) downloadJSON(window._currentRows);
  });
  document.getElementById("exportCsvBtn").addEventListener("click", () => {
    if (window._currentRows) exportCSV(window._currentRows);
  });
  document.getElementById("printBtn").addEventListener("click", () => doPrint());

  // load and render on start
  (async function init() {
    try {
      const rows = await fetchResponseRows(RESPONSE_ID);
      // store globally for exports/print
      window._currentRows = rows;
      renderRows(rows);
    } catch (err) {
      loader?.remove();
      answersSection.innerHTML = `
        <div class="p-6 bg-white rounded shadow text-center">
          <div class="text-lg font-semibold">Failed to load response</div>
          <div class="text-sm text-rose-600 mt-2">${escapeHtml(err.message)}</div>
        </div>`;
      console.error(err);
    }
  })();
</script>
</body>
</html>
