<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Question Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f1f5f9; /* slate-100 */
    }
    .glass-card {
      background: rgba(255 255 255 / 0.94);
      border-radius: 1rem;
      border: 1px solid rgba(203 213 225 / 0.4); /* slate-300 */
      box-shadow: 0 10px 25px rgba(203,213,225,0.25);
      padding: 1.5rem 2rem;
      transition: box-shadow 0.3s ease;
    }
    .glass-card:hover {
      box-shadow: 0 18px 45px rgba(203,213,225,0.4);
    }
    input[type="text"], input[type="number"], select {
      transition: all 0.3s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: #6366f1; /* indigo-500 */
      box-shadow: 0 0 0 3px rgba(99,102,241,0.3);
      background-color: white;
    }
    .btn-primary {
      @apply bg-indigo-600 text-white font-semibold rounded-lg px-6 py-2 hover:bg-indigo-700 shadow-md transition-all duration-300;
    }
    .btn-primary:active {
      @apply bg-indigo-800;
    }
    /* Custom toggle switch styled */
    .toggle-switch {
      width: 46px;
      height: 24px;
      background-color: #cbd5e1; /* slate-300 */
      border-radius: 9999px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .toggle-knob {
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 9999px;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input[type="checkbox"]:checked + .toggle-switch {
      background-color: #6366f1; /* indigo-500 */
    }
    input[type="checkbox"]:checked + .toggle-switch .toggle-knob {
      transform: translateX(22px);
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <header class="bg-indigo-600 text-white p-5 shadow-md flex justify-between items-center sticky top-0 z-10">
    <h1 class="text-2xl font-semibold tracking-wide">Manage Questions</h1>
    <button onclick="goBack()" 
            class="bg-white text-indigo-600 rounded-md px-4 py-2 font-semibold shadow hover:bg-indigo-50 transition">
      Back
    </button>
  </header>

  <!-- Container -->
  <main class="max-w-6xl mx-auto p-6 space-y-8">

    <!-- Add/Edit Form -->
    <section class="glass-card">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-3">
        <h2 class="text-3xl font-semibold text-indigo-700">Add / Edit Questions</h2>
        <p class="text-sm text-indigo-600 max-w-md">
          Configure question text, type, options, order and mandatory flag.
        </p>
      </div>

      <form id="questionForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <input type="hidden" id="questionid" />

        <!-- Question Text -->
        <div class="md:col-span-2">
          <label for="question" class="block font-semibold mb-2 text-indigo-800">Question</label>
          <input
            id="question"
            type="text"
            required
            placeholder="Enter your question text here"
            class="w-full border border-indigo-300 rounded-lg p-3 focus:outline-none focus:ring-4 focus:ring-indigo-400 transition"
          />
        </div>

        <!-- Question Type -->
        <div>
          <label for="questiontype" class="block font-semibold mb-2 text-indigo-800">Question Type</label>
          <select
            id="questiontype"
            class="w-full border border-indigo-300 rounded-lg p-3 focus:outline-none focus:ring-4 focus:ring-indigo-400 transition"
          >
            <option value="text">Text</option>
            <option value="single">Single Choice</option>
            <option value="multiple">Multiple Choice</option>
            <option value="rating_1_10">Rating</option>
          </select>
        </div>

        <!-- Mandatory Toggle -->
        <div class="flex flex-col gap-1 justify-center">
          <label class="font-semibold text-indigo-800">Mandatory</label>
          <div class="flex items-center space-x-3">
            <input id="mandatory" type="checkbox" class="hidden peer" />
            <label for="mandatory" class="toggle-switch relative flex items-center cursor-pointer select-none">
              <span class="toggle-knob"></span>
            </label>
            <span class="text-indigo-700 peer-checked:text-indigo-900 font-medium select-none">Required</span>
          </div>
          <p class="text-xs text-indigo-500 max-w-sm">
            If enabled, the respondent must answer this question before submitting.
          </p>
        </div>

        <!-- Option Inputs -->
        <div>
          <label for="option1" class="block font-semibold mb-2 text-indigo-800">Option 1</label>
          <input id="option1" type="text" placeholder="Option 1" class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition" />
        </div>
        <div>
          <label for="option2" class="block font-semibold mb-2 text-indigo-800">Option 2</label>
          <input id="option2" type="text" placeholder="Option 2" class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition" />
        </div>
        <div>
          <label for="option3" class="block font-semibold mb-2 text-indigo-800">Option 3</label>
          <input id="option3" type="text" placeholder="Option 3" class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition" />
        </div>
        <div>
          <label for="option4" class="block font-semibold mb-2 text-indigo-800">Option 4</label>
          <input id="option4" type="text" placeholder="Option 4" class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition" />
        </div>
        <div>
          <label for="option5" class="block font-semibold mb-2 text-indigo-800">Option 5</label>
          <input id="option5" type="text" placeholder="Option 5" class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition" />
        </div>
        <div>
          <label for="option6" class="block font-semibold mb-2 text-indigo-800">Option 6</label>
          <input id="option6" type="text" placeholder="Option 6" class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition" />
        </div>

        <!-- Question Order -->
        <div>
          <label for="question_order" class="block font-semibold mb-2 text-indigo-800">Order</label>
          <input
            id="question_order"
            type="number"
            min="1"
            placeholder="1"
            class="w-full border border-indigo-300 rounded-lg p-3 focus:ring-indigo-400 focus:ring-4 focus:outline-none transition"
          />
        </div>

      </form>

      <div class="mt-6 flex justify-end">
        <button onclick="saveQuestion()" class="btn-primary select-none">
          Save Question
        </button>
      </div>
    </div>

    <!-- Questions Table -->
    <section class="glass-card overflow-x-auto">
      <table class="min-w-full border-collapse text-sm text-indigo-900">
        <thead class="bg-indigo-100">
          <tr>
            <th class="p-3 border border-indigo-300 text-left font-semibold">ID</th>
            <th class="p-3 border border-indigo-300 text-left font-semibold">Question</th>
            <th class="p-3 border border-indigo-300 text-left font-semibold">Type</th>
            <th class="p-3 border border-indigo-300 text-center font-semibold">Mandatory</th>
            <th class="p-3 border border-indigo-300 text-center font-semibold">Order</th>
            <th class="p-3 border border-indigo-300 text-center font-semibold">Status</th>
            <th class="p-3 border border-indigo-300 text-center font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody id="questionBody" class="divide-y divide-indigo-200/60"></tbody>
      </table>
    </section>

  </main>

<script>
  const API_URL = "https://broad-sunset-7ec2.byash278.workers.dev";

  if (!localStorage.getItem("loggedIn")) {
    window.location.href = "login.html";
  }

  // Go back to dashboard
  function goBack() {
    window.location.href = "dashboard.html";
  }

  // Load all questions in the table
  async function loadQuestions() {
    const res = await fetch(API_URL + "/questions");
    const data = await res.json();

    const body = document.getElementById("questionBody");
    body.innerHTML = "";

    data.forEach(q => {
      body.innerHTML += `
        <tr class="hover:bg-indigo-50 transition-colors cursor-pointer">
          <td class="p-3 border border-indigo-300">${q.questionid}</td>
          <td class="p-3 max-w-xs truncate border border-indigo-300" title="${q.question}">${q.question}</td>
          <td class="p-3 capitalize border border-indigo-300">${q.questiontype}</td>
          <td class="p-3 text-center border border-indigo-300">
            ${q.mandatory ? '<span class="text-red-600 font-semibold">Yes</span>' : '<span class="text-indigo-700 font-medium">No</span>'}
          </td>
          <td class="p-3 text-center border border-indigo-300">${q.question_order ?? ""}</td>
          <td class="p-3 text-center border border-indigo-300">
            ${q.del_flag == 1 ? '<span class="text-indigo-500">Deleted</span>' : '<span class="text-green-600 font-semibold">Active</span>'}
          </td>
          <td class="p-3 flex justify-center space-x-2 border border-indigo-300">
            <button onclick='editQuestion(${JSON.stringify(q)})' class="hover:bg-yellow-300 bg-yellow-400 text-yellow-900 font-semibold rounded px-3 py-1 transition">Edit</button>
            <button onclick='deleteQuestion(${q.questionid})' class="hover:bg-red-700 bg-red-600 text-white font-semibold rounded px-3 py-1 transition">Delete</button>
          </td>
        </tr>
      `;
    });
  }

  loadQuestions();

  // Fill form for editing a question
  function editQuestion(q) {
    document.getElementById("questionid").value = q.questionid;
    document.getElementById("question").value = q.question;
    document.getElementById("questiontype").value = q.questiontype;
    document.getElementById("option1").value = q.option1 || "";
    document.getElementById("option2").value = q.option2 || "";
    document.getElementById("option3").value = q.option3 || "";
    document.getElementById("option4").value = q.option4 || "";
    document.getElementById("option5").value = q.option5 || "";
    document.getElementById("option6").value = q.option6 || "";
    document.getElementById("question_order").value = q.question_order ?? "";
    document.getElementById("mandatory").checked = !!q.mandatory;

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Save or update question
  async function saveQuestion() {
    const q = {
      questionid: document.getElementById("questionid").value,
      question: document.getElementById("question").value.trim(),
      questiontype: document.getElementById("questiontype").value,
      option1: document.getElementById("option1").value.trim(),
      option2: document.getElementById("option2").value.trim(),
      option3: document.getElementById("option3").value.trim(),
      option4: document.getElementById("option4").value.trim(),
      option5: document.getElementById("option5").value.trim(),
      option6: document.getElementById("option6").value.trim(),
      question_order: document.getElementById("question_order").value,
      mandatory: document.getElementById("mandatory").checked ? 1 : 0
    };

    await fetch(API_URL + "/questions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(q)
    });

    alert("Saved successfully");
    loadQuestions();
    document.getElementById("questionForm").reset();
    document.getElementById("mandatory").checked = false;
  }

  // Delete question (soft delete with del_flag)
  async function deleteQuestion(id) {
    if (!confirm("Are you sure?")) return;
    await fetch(API_URL + `/questions/delete/${id}`, { method: "POST" });
    loadQuestions();
  }
</script>

</body>
</html>
